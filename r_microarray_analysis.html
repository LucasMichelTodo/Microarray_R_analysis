<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-07-10 Fri 11:35 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Readme</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Lucas Michel TodÃ³" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Readme
<br />
<span class="subtitle">Micro-array generic Analysis</span>
</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org69771af">1. Introduction</a></li>
<li><a href="#org3c1a57b">2. Script: Modifiable Parts</a>
<ul>
<li><a href="#org7ad1324">2.1. Set directories</a></li>
<li><a href="#org1f674f8">2.2. Describe Data structure</a></li>
<li><a href="#org194dab4">2.3. Load Raw_Data</a></li>
<li><a href="#org5d71275">2.4. Set number of plots</a></li>
</ul>
</li>
<li><a href="#orgdbb0094">3. Script: Data Analysis</a>
<ul>
<li><a href="#orga663342">3.1. Import libraries</a></li>
<li><a href="#org9bf71bd">3.2. Create folders for output</a></li>
<li><a href="#org52fa7b3">3.3. Load Array annotation, Gene-list and Variant Genes.</a></li>
<li><a href="#org07578a6">3.4. Create Probe-DF</a></li>
<li><a href="#org9816b2e">3.5. Group Columns</a></li>
<li><a href="#org59e5188">3.6. Remove low expression probes</a></li>
<li><a href="#orge725605">3.7. Arrays QC</a>
<ul>
<li><a href="#orgb959945">3.7.1. Array Plots</a></li>
<li><a href="#orge28a9d9">3.7.2. MA Plots</a></li>
</ul>
</li>
<li><a href="#org287b86d">3.8. Eset creation</a>
<ul>
<li><a href="#orgb1ee11b">3.8.1. Change to Log2 (Log Ratio cols, originally log10)</a></li>
<li><a href="#orgfe086e5">3.8.2. Change to Log2 (Raw signal Cols, originally unlogged)</a></li>
<li><a href="#org104f522">3.8.3. Create eSet: xprobe</a></li>
<li><a href="#orgbc0a036">3.8.4. Rename and Summarize</a></li>
</ul>
</li>
<li><a href="#org56abf5d">3.9. Estimate times</a></li>
<li><a href="#orgada8321">3.10. Save results in CSVs</a></li>
<li><a href="#org2babd9b">3.11. Fold Change</a>
<ul>
<li><a href="#org109689c">3.11.1. Probe Level</a></li>
<li><a href="#org0004c88">3.11.2. Gene Level</a></li>
</ul>
</li>
<li><a href="#org7bc4f8c">3.12. Arees</a>
<ul>
<li><a href="#orgffd2a1e">3.12.1. Functions</a></li>
<li><a href="#orga92f08d">3.12.2. Calls: Compute Areas</a></li>
<li><a href="#org538b9dc">3.12.3. Calculate aAFC (average Area Fold-Change)</a></li>
</ul>
</li>
<li><a href="#org93c8db0">3.13. Plots</a>
<ul>
<li><a href="#org080329c">3.13.1. PCA Plots</a></li>
<li><a href="#orgc33be61">3.13.2. Expression Plots</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org69771af" class="outline-2">
<h2 id="org69771af"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This folder contains everything you need to run a preliminary analysis on your micro-array data.
Unzip the file wherever you want. Inside the resultant folder you should find:
</p>
<ol class="org-ol">
<li><code>microarray_analysis.R</code>: This is the R script which runs the analysis. You will first have to modify this file (on RStudio, i.e.) to fit your data and then run it.</li>
<li><code>Files</code> This folder contains necessary files for the script to run. Just leave it there (must be in the same folder as the script).</li>
<li><code>Readme.html</code> This file!</li>
</ol>

<p>
To be able to run this analysis you will need a working R installation. We highly encourage to install RStudio also, it has a way more user-friendly interface than base R.
</p>
<ul class="org-ul">
<li>To install R follow the instrucions from here: <a href="https://cran.r-project.org/">Download R</a></li>
<li>To download RStudio follow the instructions from here: <a href="https://www.rstudio.com/products/rstudio/#Desktop">Download RStudio</a></li>
</ul>

<p>
To run the analysis you just have to modify <code>microarrray_analysis.R</code> as explained in the following sections. You can modify the file using any text editor that accepts plain text (notepad, i.e.) but is probably more convinient to modify it directly on RStudio then run it.
</p>

<ol class="org-ol">
<li>Open RStudio</li>
<li>Go to <code>File</code> -&gt; <code>Open file</code> and open the script.</li>
<li>Modify the script (skip this step if you have already done it).</li>
<li>Optionally (but recomended) go to <code>Edit -&gt; Folding -&gt; Collapse All</code>. You can do the same by pressing <code>Alt+o</code>.</li>
<li>Go to <code>Code</code> -&gt; <code>Run region</code> -&gt; <code>Run All</code>. You can do the same by pressing <code>Ctl+Shift+Enter</code>.</li>
<li>A folder with your chosen name will appear on the same directory where you have the script with the results of your analysis.</li>
</ol>
</div>
</div>

<div id="outline-container-org3c1a57b" class="outline-2">
<h2 id="org3c1a57b"><span class="section-number-2">2</span> Script: Modifiable Parts</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">############## </span><span style="color: #7F9F7F;">Experiment Setup: MODIFY THIS PART #######################</span>
<span style="color: #5F7F5F;">##</span><span style="color: #7F9F7F;">*********************************************************************##</span>
<span style="color: #5F7F5F;">##</span><span style="color: #7F9F7F;">*********************************************************************##</span>
</pre>
</div>
<p>
The only part of code that must be modified are the ones depicted here. They correspond to the begining of the script.
</p>
</div>
<div id="outline-container-org7ad1324" class="outline-3">
<h3 id="org7ad1324"><span class="section-number-3">2.1</span> Set directories</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Set directories</span>

datadir <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #CC9393;">"./Raw_Data/"</span>
outdir <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #CC9393;">"./R_results"</span>
annot <span style="color: #BFEBBF;">&lt;-</span> read.csv(<span style="color: #CC9393;">"./Files/array_anotation.csv"</span>, sep=<span style="color: #CC9393;">"\t"</span>, header = F)
infiles <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #CC9393;">"./Files/"</span>
</pre>
</div>

<ul class="org-ul">
<li><code>datadir</code> Set to the path of the folder where the raw-data is. (remember that in windows "\" must be replaced by "/").</li>
<li><code>outdir</code> Set this variable to any name you want. A folder with this name will be created and all outputs will be stored in it.</li>
<li><code>annot</code> Set this variable to the path to the annotation file for this array.</li>
<li><code>infiles</code> Set this variable to the path to the folder where files necessary for this analysis is located.</li>
</ul>
</div>
</div>

<div id="outline-container-org1f674f8" class="outline-3">
<h3 id="org1f674f8"><span class="section-number-3">2.2</span> Describe Data structure</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Example code:
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Describe Data structure ##</span>

nsamples <span style="color: #BFEBBF;">&lt;-</span> 9
sample_names <span style="color: #BFEBBF;">&lt;-</span> c(<span style="color: #CC9393;">"Ctl_1"</span>,
                  <span style="color: #CC9393;">"Ctl_2"</span>,
                  <span style="color: #CC9393;">"Ctl_3"</span>,
                  <span style="color: #CC9393;">"A_1"</span>,
                  <span style="color: #CC9393;">"A_2"</span>,
                  <span style="color: #CC9393;">"A_3"</span>,
                  <span style="color: #CC9393;">"B_1"</span>,
                  <span style="color: #CC9393;">"B_2"</span>,
                  <span style="color: #CC9393;">"B_3"</span>)

times <span style="color: #BFEBBF;">&lt;-</span> c(1,2,3, 1,2,3, 1,2,3)
types <span style="color: #BFEBBF;">&lt;-</span> c(<span style="color: #CC9393;">"ctl"</span>, <span style="color: #CC9393;">"ctl"</span>, <span style="color: #CC9393;">"ctl"</span>, <span style="color: #CC9393;">"treatA"</span>, <span style="color: #CC9393;">"treatA"</span>, <span style="color: #CC9393;">"treatA"</span>, <span style="color: #CC9393;">"treatB"</span>, <span style="color: #CC9393;">"treatB"</span>, <span style="color: #CC9393;">"treatB"</span>)

</pre>
</div>

<p>
In this part you have to modify the following variables:
</p>
<ul class="org-ul">
<li><code>nsamples</code> Set to the total number of samples (micro-arrays) in your experient.</li>

<li><code>sample_names</code> Set to the name you want for each sample. It will be used to name the columns in the generated tables.</li>

<li><code>times</code> Set to a series of coma-separated integers. It represents the ordinal time-points of your experiments (1,2,3&#x2026;). Do not confound with real age/hpi which will be inferred from the expression data. The order of the time-points must correspond to the sample order. For example, if samples 1 and 2 correspond to treatment and control of the first time-point and samples 3 and 4 to the second time-point, must be set to: <code>times &lt;- c(1,1,2,2)</code></li>

<li><code>types</code> Set to a coma separated list of quoted names. It represents the status of each sample regarding the variable of interest (teatment/control, strainA/strainB/strainC, wt/KO&#x2026;). Again the order of the labels must correspond to the order of the samples.</li>
</ul>
</div>
</div>
<div id="outline-container-org194dab4" class="outline-3">
<h3 id="org194dab4"><span class="section-number-3">2.3</span> Load Raw_Data</h3>
<div class="outline-text-3" id="text-2-3">
<p>
In this part of the script we define the computer folder in which we will be working and load the raw array data.
</p>

<p>
Example code:
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Load Raw_Data</span>

Ctl_1 <span style="color: #BFEBBF;">&lt;-</span> read.table(paste0(datadir, <span style="color: #CC9393;">"ctl_tp1.txt"</span>), sep=<span style="color: #CC9393;">"\t"</span>,stringsAsFactors=<span style="color: #7CB8BB;">FALSE</span>, skip = 9, header = <span style="color: #7CB8BB;">TRUE</span>)
Ctl_2 <span style="color: #BFEBBF;">&lt;-</span> read.table(paste0(datadir, <span style="color: #CC9393;">"ctl_tp2.txt"</span>), sep=<span style="color: #CC9393;">"\t"</span>,stringsAsFactors=<span style="color: #7CB8BB;">FALSE</span>, skip = 9, header = <span style="color: #7CB8BB;">TRUE</span>)
Ctl_3 <span style="color: #BFEBBF;">&lt;-</span> read.table(paste0(datadir, <span style="color: #CC9393;">"ctl_tp3.txt"</span>), sep=<span style="color: #CC9393;">"\t"</span>,stringsAsFactors=<span style="color: #7CB8BB;">FALSE</span>, skip = 9, header = <span style="color: #7CB8BB;">TRUE</span>)


A_1 <span style="color: #BFEBBF;">&lt;-</span> read.table(paste0(datadir, <span style="color: #CC9393;">"treatA_tp1.txt"</span>), sep=<span style="color: #CC9393;">"\t"</span>,stringsAsFactors=<span style="color: #7CB8BB;">FALSE</span>, skip = 9, header = <span style="color: #7CB8BB;">TRUE</span>)
A_2 <span style="color: #BFEBBF;">&lt;-</span> read.table(paste0(datadir, <span style="color: #CC9393;">"treatA_tp2.txt"</span>), sep=<span style="color: #CC9393;">"\t"</span>,stringsAsFactors=<span style="color: #7CB8BB;">FALSE</span>, skip = 9, header = <span style="color: #7CB8BB;">TRUE</span>)
A_3 <span style="color: #BFEBBF;">&lt;-</span> read.table(paste0(datadir, <span style="color: #CC9393;">"treatA_tp3.txt"</span>), sep=<span style="color: #CC9393;">"\t"</span>,stringsAsFactors=<span style="color: #7CB8BB;">FALSE</span>, skip = 9, header = <span style="color: #7CB8BB;">TRUE</span>)

B_1 <span style="color: #BFEBBF;">&lt;-</span> read.table(paste0(datadir, <span style="color: #CC9393;">"treatB_tp1.txt"</span>), sep=<span style="color: #CC9393;">"\t"</span>,stringsAsFactors=<span style="color: #7CB8BB;">FALSE</span>, skip = 9, header = <span style="color: #7CB8BB;">TRUE</span>)
B_2 <span style="color: #BFEBBF;">&lt;-</span> read.table(paste0(datadir, <span style="color: #CC9393;">"treatB_tp2.txt"</span>), sep=<span style="color: #CC9393;">"\t"</span>,stringsAsFactors=<span style="color: #7CB8BB;">FALSE</span>, skip = 9, header = <span style="color: #7CB8BB;">TRUE</span>)
B_3 <span style="color: #BFEBBF;">&lt;-</span> read.table(paste0(datadir, <span style="color: #CC9393;">"treatB_tp3.txt"</span>), sep=<span style="color: #CC9393;">"\t"</span>,stringsAsFactors=<span style="color: #7CB8BB;">FALSE</span>, skip = 9, header = <span style="color: #7CB8BB;">TRUE</span>)

array_list <span style="color: #BFEBBF;">&lt;-</span> list(Ctl_1,
                   Ctl_2,
                   Ctl_3,
                   A_1,
                   A_2,
                   A_3,
                   B_1,
                   B_2,
                   B_3)

</pre>
</div>

<ul class="org-ul">
<li><code>Filenames</code> <i>(ctl_tp1.txt, ctl_tp2.txt, &#x2026;)</i> In this part you just have to change the quoted part with the name of the file ("ctl_tp1.txt" in the example above). Change it for the names of your raw-data files.</li>
<li><code>Sample names</code> <i>(Ctl_1, Ctl_2, &#x2026;)</i> Set each sample to the same names you set in the previous part.</li>
<li><code>array_list</code> Fill this list with the sample names. They must be <b>unquoted</b>. They must be in the same order you specified in <code>sample_names</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org5d71275" class="outline-3">
<h3 id="org5d71275"><span class="section-number-3">2.4</span> Set number of plots</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Example code:
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Set number of plots</span>

run_all_plots <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #CC9393;">"no"</span>
</pre>
</div>

<ul class="org-ul">
<li><code>run_all_plots</code> If this variable is set to "yes" expression plots for each gene and probe both for red/green ratio and red-signal will be plotted. This can be quite time and computer-resource consuming so by default it is set to "no" and only 20 plots of each class will be plotted as an example.</li>
</ul>

<p>
Thats all! You are now set to run the analysis. Just start an R session, run the modified script and enjoy!
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">##</span><span style="color: #7F9F7F;">*********************************************************************##</span>
<span style="color: #5F7F5F;">##</span><span style="color: #7F9F7F;">********************* END OF MODIFIABLE PART ************************##</span>
<span style="color: #5F7F5F;">##</span><span style="color: #7F9F7F;">*********************************************************************##</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgdbb0094" class="outline-2">
<h2 id="orgdbb0094"><span class="section-number-2">3</span> Script: Data Analysis</h2>
<div class="outline-text-2" id="text-3">
<p>
This is the part of the script that runs the analysis. You do not have to modifiy anything from here on, but if you are curious here is the code!
</p>
</div>
<div id="outline-container-orga663342" class="outline-3">
<h3 id="orga663342"><span class="section-number-3">3.1</span> Import libraries</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Import libraries ####</span>

print(<span style="color: #CC9393;">"Importing Libraries..."</span>)
list.of.packages <span style="color: #BFEBBF;">&lt;-</span> c(<span style="color: #CC9393;">"reshape2"</span>, <span style="color: #CC9393;">"ggfortify"</span>, <span style="color: #CC9393;">"tidyverse"</span>, <span style="color: #CC9393;">"RColorBrewer"</span>, <span style="color: #CC9393;">"sp"</span>)
new.packages <span style="color: #BFEBBF;">&lt;-</span> list.of.packages[!(list.of.packages <span style="color: #BFEBBF;">%in%</span> installed.packages()[,<span style="color: #CC9393;">"Package"</span>])]
<span style="color: #F0DFAF; font-weight: bold;">if</span>(length(new.packages)) install.packages(new.packages)

<span style="color: #BFEBBF;">library</span>(reshape2)
<span style="color: #BFEBBF;">library</span>(ggfortify)
<span style="color: #BFEBBF;">library</span>(tidyverse)
<span style="color: #BFEBBF;">library</span>(RColorBrewer)
<span style="color: #BFEBBF;">library</span>(sp)

<span style="color: #F0DFAF; font-weight: bold;">if</span> (!(<span style="color: #CC9393;">"Biobase"</span> <span style="color: #BFEBBF;">%in%</span> installed.packages()[,<span style="color: #CC9393;">"Package"</span>])){
  <span style="color: #F0DFAF; font-weight: bold;">if</span> (!requireNamespace(<span style="color: #CC9393;">"BiocManager"</span>, quietly = <span style="color: #7CB8BB;">TRUE</span>))
    install.packages(<span style="color: #CC9393;">"BiocManager"</span>)
  BiocManager::install()
}

<span style="color: #BFEBBF;">library</span>(Biobase)
</pre>
</div>
</div>
</div>

<div id="outline-container-org9bf71bd" class="outline-3">
<h3 id="org9bf71bd"><span class="section-number-3">3.2</span> Create folders for output</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Create folders for output ####</span>

print(<span style="color: #CC9393;">"Creating folders for Output..."</span>)
dir.create(paste0(outdir))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots"</span>))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots/Array_Plots"</span>))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots/MA_Plots"</span>))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots/Time_estim/"</span>))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots/Ratio"</span>))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots/Ratio/Gene_Level"</span>))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots/Ratio/Probe_Level"</span>))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots/Ratio/Gene_Level"</span>))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots/Red_Signal"</span>))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots/Red_Signal/Gene_Level"</span>))
dir.create(paste0(outdir, <span style="color: #CC9393;">"/Plots/Red_Signal/Probe_Level"</span>))
figPath <span style="color: #BFEBBF;">&lt;-</span> paste0(outdir, <span style="color: #CC9393;">"/Plots/"</span>)

</pre>
</div>
</div>
</div>

<div id="outline-container-org52fa7b3" class="outline-3">
<h3 id="org52fa7b3"><span class="section-number-3">3.3</span> Load Array annotation, Gene-list and Variant Genes.</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Load <code>array_anotation.csv</code> a table with the array annotation.
Load <code>gene_list.txt</code> a list of genes present in the array.
This will be used for calculating the mean intensity in the array
for excluding low expressed genes.
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Load Array annotation, Gene-list and Variant Genes ####</span>

print(<span style="color: #CC9393;">"Loading Array Annotation..."</span>)
gene_list <span style="color: #BFEBBF;">&lt;-</span> readLines(paste0(infiles, <span style="color: #CC9393;">"gene_list.txt"</span>))

cvgs <span style="color: #BFEBBF;">&lt;-</span> read.csv2(paste0(infiles, <span style="color: #CC9393;">'taula_CVG_final.csv'</span>), stringsAsFactors = F)
cvgs <span style="color: #BFEBBF;">&lt;-</span> cvgs <span style="color: #BFEBBF;">%&gt;%</span>
  select(Gene_id = Gene.ID, Variant = Final.Customized) <span style="color: #BFEBBF;">%&gt;%</span>
  mutate(Variant = ifelse(Variant == <span style="color: #CC9393;">'YES'</span>, <span style="color: #7CB8BB;">TRUE</span>, <span style="color: #7CB8BB;">FALSE</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org07578a6" class="outline-3">
<h3 id="org07578a6"><span class="section-number-3">3.4</span> Create Probe-DF</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Create Probe-DF ####</span>

print(<span style="color: #CC9393;">"Creating Probe DF..."</span>)
probe_df <span style="color: #BFEBBF;">&lt;-</span> array_list[[1]][,c(7,11,14,15)]

<span style="color: #93E0E3;">getCols</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(df){
  <span style="color: #F0DFAF; font-weight: bold;">return</span>(df[,c(11,14,15)])
}

goodCols <span style="color: #BFEBBF;">&lt;-</span> lapply(array_list[2:nsamples], <span style="color: #F0DFAF; font-weight: bold;">function</span>(x) getCols(x))
df <span style="color: #BFEBBF;">&lt;-</span> do.call(<span style="color: #CC9393;">"cbind"</span>, goodCols)

probe_df <span style="color: #BFEBBF;">&lt;-</span> cbind(probe_df, df)

probe_df[<span style="color: #CC9393;">"Gene_id"</span>] <span style="color: #BFEBBF;">&lt;-</span> annot$V2
probe_df[<span style="color: #CC9393;">"name"</span>] <span style="color: #BFEBBF;">&lt;-</span> annot$V4
probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> annot$V5

probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"Plasmodium"</span>, <span style="color: #CC9393;">"Pl."</span>, probe_df$Annot)
probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"protein"</span>, <span style="color: #CC9393;">"prot."</span>, probe_df$Annot)
probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"membrane"</span>, <span style="color: #CC9393;">"memb."</span>, probe_df$Annot)
probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"conserved"</span>, <span style="color: #CC9393;">"cvd."</span>, probe_df$Annot)
probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"function"</span>, <span style="color: #CC9393;">"func."</span>, probe_df$Annot)
probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"unknown"</span>, <span style="color: #CC9393;">"ukwn."</span>, probe_df$Annot)
probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"exported"</span>, <span style="color: #CC9393;">"xptd."</span>, probe_df$Annot)
probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"pseudogene"</span>, <span style="color: #CC9393;">"pseudo"</span>, probe_df$Annot)
probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"putative"</span>, <span style="color: #CC9393;">"put."</span>, probe_df$Annot)
probe_df[<span style="color: #CC9393;">"Annot"</span>] <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"%2C"</span>, <span style="color: #CC9393;">""</span>, probe_df$Annot)

<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Remove probes that map tu multiple genes.</span>
probe_df <span style="color: #BFEBBF;">&lt;-</span> probe_df[annot$V3 != <span style="color: #CC9393;">"drop"</span> | is.na(annot$V3),]

<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Add Variant Genes information</span>
varlist <span style="color: #BFEBBF;">&lt;-</span> dplyr::filter(cvgs, Variant) <span style="color: #BFEBBF;">%&gt;%</span> select(Gene_id)
probe_df[<span style="color: #CC9393;">"Variant"</span>] <span style="color: #BFEBBF;">&lt;-</span> probe_df$Gene_id <span style="color: #BFEBBF;">%in%</span> varlist
</pre>
</div>
</div>
</div>

<div id="outline-container-org9816b2e" class="outline-3">
<h3 id="org9816b2e"><span class="section-number-3">3.5</span> Group Columns</h3>
<div class="outline-text-3" id="text-3-5">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Group Columns ####</span>

signalCols <span style="color: #BFEBBF;">&lt;-</span> nsamples*3+1
allcols <span style="color: #BFEBBF;">&lt;-</span> dim(probe_df)[2]

ratioCols <span style="color: #BFEBBF;">&lt;-</span> seq(2, signalCols, 3)
redCols <span style="color: #BFEBBF;">&lt;-</span> seq(4, signalCols, 3)
greCols <span style="color: #BFEBBF;">&lt;-</span> seq(3, signalCols, 3)

infoCols <span style="color: #BFEBBF;">&lt;-</span> c(1, (signalCols+1):allcols)
</pre>
</div>
</div>
</div>
<div id="outline-container-org59e5188" class="outline-3">
<h3 id="org59e5188"><span class="section-number-3">3.6</span> Remove low expression probes</h3>
<div class="outline-text-3" id="text-3-6">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Remove low expression probes ####</span>

print(<span style="color: #CC9393;">"Removing low expression probes..."</span>)
medians <span style="color: #BFEBBF;">&lt;-</span> list()
<span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> 1:nsamples){
  redm <span style="color: #BFEBBF;">&lt;-</span> median(sort(probe_df[probe_df$Gene_id <span style="color: #BFEBBF;">%in%</span> gene_list, redCols][,i])[1:100])
  grenm <span style="color: #BFEBBF;">&lt;-</span> median(sort(probe_df[probe_df$Gene_id <span style="color: #BFEBBF;">%in%</span> gene_list, greCols][,i])[1:100])
  medians[[i]] <span style="color: #BFEBBF;">&lt;-</span> c(grenm, redm)
}

passTest <span style="color: #BFEBBF;">&lt;-</span> list()
<span style="color: #F0DFAF; font-weight: bold;">for</span>(i <span style="color: #F0DFAF; font-weight: bold;">in</span> 1:nsamples){
  g <span style="color: #BFEBBF;">&lt;-</span> probe_df[,greCols][i] &lt; 3*medians[[i]][1]
  r <span style="color: #BFEBBF;">&lt;-</span> probe_df[,redCols][i] &lt; 3*medians[[i]][2]
  all <span style="color: #BFEBBF;">&lt;-</span> g &amp; r
  passTest[[i]] <span style="color: #BFEBBF;">&lt;-</span> !all
}

testDF <span style="color: #BFEBBF;">&lt;-</span> as.data.frame(passTest)
pass <span style="color: #BFEBBF;">&lt;-</span> rowSums(testDF) &gt; 0
write.csv(table(!pass), paste0(outdir, <span style="color: #CC9393;">"/NA_probes.csv"</span>))
probe_df[!pass,c(ratioCols)] <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #7CB8BB;">NA</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge725605" class="outline-3">
<h3 id="orge725605"><span class="section-number-3">3.7</span> Arrays QC</h3>
<div class="outline-text-3" id="text-3-7">
</div>
<div id="outline-container-orgb959945" class="outline-4">
<h4 id="orgb959945"><span class="section-number-4">3.7.1</span> Array Plots</h4>
<div class="outline-text-4" id="text-3-7-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Array Plots ####</span>

print(<span style="color: #CC9393;">"Plotting Arrays..."</span>)
cols <span style="color: #BFEBBF;">&lt;-</span> rev(brewer.pal(11, <span style="color: #CC9393;">'Spectral'</span>))

<span style="color: #93E0E3;">arrayPlot</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(df) {
  df_name <span style="color: #BFEBBF;">&lt;-</span> sample_names[i]
  p1 <span style="color: #BFEBBF;">&lt;-</span> qplot(Col, Row, data=df, color=log2(rMedianSignal)&lt;7) + scale_color_manual(values=c(<span style="color: #CC9393;">"aliceblue"</span>, <span style="color: #CC9393;">"black"</span>)) + ggtitle(df_name)
  ggsave(p1, filename = paste0(figPath, <span style="color: #CC9393;">"Array_Plots/sample_"</span>, df_name, <span style="color: #CC9393;">"_boolean.jpeg"</span>), device = <span style="color: #CC9393;">"jpeg"</span>)

  p2 <span style="color: #BFEBBF;">&lt;-</span> qplot(Col, Row, data=df, color=log2(rMedianSignal)) + scale_colour_gradientn(colours = cols) + ggtitle(df_name)
  ggsave(p2, filename = paste0(figPath, <span style="color: #CC9393;">"Array_Plots/sample_"</span>, df_name, <span style="color: #CC9393;">".jpeg"</span>), device = <span style="color: #CC9393;">"jpeg"</span>)

  p3 <span style="color: #BFEBBF;">&lt;-</span> qplot(Col, Row, data=df, color=is.na(LogRatio)) + scale_color_manual(values=c(<span style="color: #CC9393;">"aliceblue"</span>, <span style="color: #CC9393;">"red"</span>)) + ggtitle(df_name)
  ggsave(p3, filename = paste0(figPath, <span style="color: #CC9393;">"Array_Plots/sample_"</span>, df_name, <span style="color: #CC9393;">"_NAs.jpeg"</span>), device = <span style="color: #CC9393;">"jpeg"</span>)
}

<span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> 1:length(array_list)) {arrayPlot(array_list[[i]])}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge28a9d9" class="outline-4">
<h4 id="orge28a9d9"><span class="section-number-4">3.7.2</span> MA Plots</h4>
<div class="outline-text-4" id="text-3-7-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">MA Plots ####</span>

print(<span style="color: #CC9393;">"Plotting MA Plots..."</span>)
<span style="color: #93E0E3;">myMAplot</span>  <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(mray){
  df_name <span style="color: #BFEBBF;">&lt;-</span> sample_names[i]
  m_vals <span style="color: #BFEBBF;">&lt;-</span> log2(mray$gProcessedSignal) - log2(mray$rProcessedSignal)
  a_vals <span style="color: #BFEBBF;">&lt;-</span> (log2(mray$gProcessedSignal) + log2(mray$rProcessedSignal))/2
  ma_df <span style="color: #BFEBBF;">&lt;-</span> cbind(a_vals, m_vals)
  p <span style="color: #BFEBBF;">&lt;-</span> ggplot(ma_df, aes(x=a_vals, y=m_vals))
  p <span style="color: #BFEBBF;">&lt;-</span> p + geom_point()
  p <span style="color: #BFEBBF;">&lt;-</span> p + geom_smooth(method = <span style="color: #CC9393;">"lm"</span>, se=F, color= <span style="color: #CC9393;">"red"</span>)
  p <span style="color: #BFEBBF;">&lt;-</span> p + geom_hline(yintercept=0, color = <span style="color: #CC9393;">"blue"</span>, size = 1)
  ggsave(p, filename = paste0(figPath, <span style="color: #CC9393;">"MA_Plots/sample_"</span>, df_name, <span style="color: #CC9393;">"_MA.jpeg"</span>), device = <span style="color: #CC9393;">"jpeg"</span>)
}

<span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> 1:length(array_list)) {myMAplot(array_list[[i]])}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org287b86d" class="outline-3">
<h3 id="org287b86d"><span class="section-number-3">3.8</span> Eset creation</h3>
<div class="outline-text-3" id="text-3-8">
</div>
<div id="outline-container-orgb1ee11b" class="outline-4">
<h4 id="orgb1ee11b"><span class="section-number-4">3.8.1</span> Change to Log2 (Log Ratio cols, originally log10)</h4>
<div class="outline-text-4" id="text-3-8-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Change to Log2 (Log Ratio cols, originally log10) ####</span>

print(<span style="color: #CC9393;">"Creating Eset..."</span>)
probe_df[,ratioCols] <span style="color: #BFEBBF;">&lt;-</span> log2(10**probe_df[,ratioCols])
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfe086e5" class="outline-4">
<h4 id="orgfe086e5"><span class="section-number-4">3.8.2</span> Change to Log2 (Raw signal Cols, originally unlogged)</h4>
<div class="outline-text-4" id="text-3-8-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Change to Log2 (Raw signal Cols, originally unlogged) ####</span>

probe_df[,redCols]  <span style="color: #BFEBBF;">&lt;-</span> log2(probe_df[,redCols])
</pre>
</div>
</div>
</div>

<div id="outline-container-org104f522" class="outline-4">
<h4 id="org104f522"><span class="section-number-4">3.8.3</span> Create eSet: xprobe</h4>
<div class="outline-text-4" id="text-3-8-3">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Create eSet: xprobe ####</span>

exprsx <span style="color: #BFEBBF;">&lt;-</span> as.matrix(probe_df[,ratioCols])
colnames(exprsx) <span style="color: #BFEBBF;">&lt;-</span> sample_names
fdata <span style="color: #BFEBBF;">&lt;-</span> new(<span style="color: #CC9393;">"AnnotatedDataFrame"</span>, probe_df[,infoCols])
teor_time <span style="color: #BFEBBF;">&lt;-</span> times
type <span style="color: #BFEBBF;">&lt;-</span> types
pdata <span style="color: #BFEBBF;">&lt;-</span> data.frame(type=type, teor_time=teor_time); rownames(pdata) <span style="color: #BFEBBF;">&lt;-</span> sample_names
pdata <span style="color: #BFEBBF;">&lt;-</span> new(<span style="color: #CC9393;">"AnnotatedDataFrame"</span>, pdata)
xprobe <span style="color: #BFEBBF;">&lt;-</span> new(<span style="color: #CC9393;">"ExpressionSet"</span>, exprs=exprsx, featureData=fdata, phenoData=pdata)
save(xprobe,file=paste0(outdir, <span style="color: #CC9393;">'/probeLevel.RData'</span>))

exprsx <span style="color: #BFEBBF;">&lt;-</span> as.matrix(probe_df[,redCols])
colnames(exprsx) <span style="color: #BFEBBF;">&lt;-</span> sample_names
xprobe_red <span style="color: #BFEBBF;">&lt;-</span> new(<span style="color: #CC9393;">"ExpressionSet"</span>, exprs=exprsx, featureData=fdata, phenoData=pdata)

write.csv(cbind(fdata@data, exprs(xprobe)), paste0(outdir, <span style="color: #CC9393;">"/probeLevel_exp.csv"</span>), row.names=F)
write.csv(cbind(fdata@data, exprs(xprobe_red)), paste0(outdir, <span style="color: #CC9393;">"/probeLevel_redSignalexp.csv"</span>), row.names=F)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbc0a036" class="outline-4">
<h4 id="orgbc0a036"><span class="section-number-4">3.8.4</span> Rename and Summarize</h4>
<div class="outline-text-4" id="text-3-8-4">
<p>
Summarize all probes for a same gene, using median polish.
Here we are considering the ratio between green and red signal as the expression
value.
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Rename and Summarize ####</span>

<span style="color: #93E0E3;">myRma</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(x) {
  <span style="color: #F0DFAF; font-weight: bold;">if</span> (class(x)==<span style="color: #CC9393;">'numeric'</span>) {
    ans <span style="color: #BFEBBF;">&lt;-</span> x
  } <span style="color: #F0DFAF; font-weight: bold;">else</span> {
    ans <span style="color: #BFEBBF;">&lt;-</span> medpolish(x,trace.iter=<span style="color: #7CB8BB;">FALSE</span>,na.rm=<span style="color: #7CB8BB;">TRUE</span>)
    ans <span style="color: #BFEBBF;">&lt;-</span> ans$overall + ans$col
  }
  <span style="color: #F0DFAF; font-weight: bold;">return</span>(ans)
}

<span style="color: #93E0E3;">renameGenesAndSummarize</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(genesToRename.sd,exprsx,geneid,summaryMethod=myRma,type) {

  <span style="color: #F0DFAF; font-weight: bold;">if</span> (type == <span style="color: #CC9393;">"ratio"</span>){
    xgene <span style="color: #BFEBBF;">&lt;-</span> by(exprsx[,ratioCols],geneid,myRma)
  } <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (type == <span style="color: #CC9393;">"red"</span>){
    xgene <span style="color: #BFEBBF;">&lt;-</span> by(exprsx[,redCols],geneid,myRma)
  }

  xgene <span style="color: #BFEBBF;">&lt;-</span> do.call(<span style="color: #CC9393;">'rbind'</span>,xgene)

  <span style="color: #93E0E3;">mysd</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(x) { ans <span style="color: #BFEBBF;">&lt;-</span> ifelse(sum(!is.na(x))==1,0,sd(x,na.rm=<span style="color: #7CB8BB;">TRUE</span>)); <span style="color: #F0DFAF; font-weight: bold;">return</span>(ans) }
  sdgene <span style="color: #BFEBBF;">&lt;-</span> aggregate(exprsx[, ratioCols],by=list(geneid),FUN=mysd)

  names(sdgene)[1] <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #CC9393;">'geneid'</span>
  xgene <span style="color: #BFEBBF;">&lt;-</span> data.frame(geneid=rownames(xgene),xgene); rownames(xgene) <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #7CB8BB;">NULL</span>

  fdata <span style="color: #BFEBBF;">&lt;-</span> by(exprsx[,(signalCols+1):allcols],geneid,unique)

  genenames <span style="color: #BFEBBF;">&lt;-</span> names(fdata)
  fdata <span style="color: #BFEBBF;">&lt;-</span> do.call(<span style="color: #CC9393;">'rbind'</span>,fdata)

  fdata <span style="color: #BFEBBF;">&lt;-</span> new(<span style="color: #CC9393;">"AnnotatedDataFrame"</span>, data.frame(fdata))
  rownames(fdata) <span style="color: #BFEBBF;">&lt;-</span> as.character(xgene$geneid)

  exprsxgene <span style="color: #BFEBBF;">&lt;-</span> as.matrix(xgene[,-1])
  rownames(exprsxgene) <span style="color: #BFEBBF;">&lt;-</span> as.character(xgene$geneid);
  colnames(exprsxgene) <span style="color: #BFEBBF;">&lt;-</span> sample_names
  eset <span style="color: #BFEBBF;">&lt;-</span> new(<span style="color: #CC9393;">"ExpressionSet"</span>,exprs=exprsxgene, featureData=fdata, phenoData=pdata)
  <span style="color: #F0DFAF; font-weight: bold;">return</span>(list(eset=eset,sdgene=sdgene,fdata=fdata,geneid=geneid))
}

geneid <span style="color: #BFEBBF;">&lt;-</span> probe_df$Gene_id
geneid <span style="color: #BFEBBF;">&lt;-</span> as.character(geneid)
genesToRename.sd <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #7CB8BB;">NA</span>

tmp <span style="color: #BFEBBF;">&lt;-</span> renameGenesAndSummarize(genesToRename.sd=genesToRename.sd,exprsx=probe_df,geneid=geneid,summaryMethod=myRma, type=<span style="color: #CC9393;">"ratio"</span>)
xgene <span style="color: #BFEBBF;">&lt;-</span> tmp[[<span style="color: #CC9393;">'eset'</span>]]; sdgene <span style="color: #BFEBBF;">&lt;-</span> tmp[[<span style="color: #CC9393;">'sdgene'</span>]]; fdata <span style="color: #BFEBBF;">&lt;-</span> tmp[[<span style="color: #CC9393;">'fdata'</span>]]; geneid <span style="color: #BFEBBF;">&lt;-</span> tmp[[<span style="color: #CC9393;">'geneid'</span>]]

tmp2 <span style="color: #BFEBBF;">&lt;-</span> renameGenesAndSummarize(genesToRename.sd=genesToRename.sd,exprsx=probe_df,geneid=geneid,summaryMethod=myRma, type=<span style="color: #CC9393;">"red"</span>)
xgene_red <span style="color: #BFEBBF;">&lt;-</span> tmp2[[<span style="color: #CC9393;">'eset'</span>]]; sdgene <span style="color: #BFEBBF;">&lt;-</span> tmp2[[<span style="color: #CC9393;">'sdgene'</span>]]; fdata <span style="color: #BFEBBF;">&lt;-</span> tmp2[[<span style="color: #CC9393;">'fdata'</span>]]; geneid <span style="color: #BFEBBF;">&lt;-</span> tmp2[[<span style="color: #CC9393;">'geneid'</span>]]
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org56abf5d" class="outline-3">
<h3 id="org56abf5d"><span class="section-number-3">3.9</span> Estimate times</h3>
<div class="outline-text-3" id="text-3-9">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Estimate times ####</span>

print(<span style="color: #CC9393;">"Estimating times..."</span>)
bozdechPath <span style="color: #BFEBBF;">&lt;-</span> paste0(infiles, <span style="color: #CC9393;">'bozdech_Hb3_clean2.csv'</span>)
LemieuxFunctionsPath <span style="color: #BFEBBF;">&lt;-</span> paste0(infiles, <span style="color: #CC9393;">'lemieux_et_al_pipeline_functions.r'</span>)

<span style="color: #93E0E3;">getTimeEstimation</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(x,dataPath,functionsPath,figuresPath,B=100) {
                                        <span style="color: #5F7F5F;">#  </span><span style="color: #7F9F7F;">x: the expressionSet for which we want to estimate times (our data).</span>
                                        <span style="color: #5F7F5F;">#  </span><span style="color: #7F9F7F;">dataPath: path to data that will be used to estimate timepoints (from Bozdech et al)</span>
                                        <span style="color: #5F7F5F;">#  </span><span style="color: #7F9F7F;">functionsPath: path to the script containing the functions from Lemieux's paper.</span>
                                        <span style="color: #5F7F5F;">#  </span><span style="color: #7F9F7F;">figuresPath: where we want to save the output plots.</span>
  <span style="color: #BFEBBF;">source</span>(functionsPath)
                                        <span style="color: #5F7F5F;">#  </span><span style="color: #7F9F7F;">z &lt;- read.csv(dataPath, as.is = T,sep='\t')</span>
  z <span style="color: #BFEBBF;">&lt;-</span> read.csv(dataPath, as.is = T)
                                        <span style="color: #5F7F5F;">#  </span><span style="color: #7F9F7F;">colnames(z)[1] &lt;- 'Name'</span>
                                        <span style="color: #5F7F5F;">#  </span><span style="color: #7F9F7F;">oldTime &lt;- as.numeric(as.character(pData(x)$time))</span>
  oldTime <span style="color: #BFEBBF;">&lt;-</span> as.numeric(teor_time)
  x <span style="color: #BFEBBF;">&lt;-</span> exprs(x)
  x <span style="color: #BFEBBF;">&lt;-</span> data.frame(Name=as.character(rownames(x)),x,stringsAsFactors=<span style="color: #7CB8BB;">FALSE</span>); rownames(x) <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #7CB8BB;">NULL</span>
  data <span style="color: #BFEBBF;">&lt;-</span> sync_data(x, z)
  x <span style="color: #BFEBBF;">&lt;-</span> data[[1]]
  z <span style="color: #BFEBBF;">&lt;-</span> data[[2]]
  x <span style="color: #BFEBBF;">&lt;-</span> ordinal(x, use.name = T)
  z <span style="color: #BFEBBF;">&lt;-</span> ordinal(z, use.name = T)
                                        <span style="color: #5F7F5F;">#  </span><span style="color: #7F9F7F;">z.na &lt;- cbind(z[,1:22], rep(NA, nrow(z)), z[,23:27], rep(NA, nrow(z)), z[,28:56])</span>
  z.na <span style="color: #BFEBBF;">&lt;-</span> cbind(z[,1:22], rep(<span style="color: #7CB8BB;">NA</span>, nrow(z)), z[,23:27], rep(<span style="color: #7CB8BB;">NA</span>, nrow(z)), z[,28:46])
  z <span style="color: #BFEBBF;">&lt;-</span> t(apply(z.na, 1, smooth.missing))
  sigma.epsilon <span style="color: #BFEBBF;">&lt;-</span> 789.9056
  z.smooth <span style="color: #BFEBBF;">&lt;-</span> smooth.ref(z, method = <span style="color: #CC9393;">"spline"</span>, spar = 0.5)
  z.smooth.hourly <span style="color: #BFEBBF;">&lt;-</span> z.smooth[,ll.par$hourly]
                                        <span style="color: #5F7F5F;">#  </span><span style="color: #7F9F7F;">sigma.eta &lt;- mean(sd(z[,11:ncol(z)] - z.smooth.hourly, na.rm = T), na.rm=T)</span>
  sigma.eta <span style="color: #BFEBBF;">&lt;-</span> mean(sd(z - z.smooth.hourly, na.rm = T), na.rm=T)
  new.sigma <span style="color: #BFEBBF;">&lt;-</span> sqrt(sigma.eta^2 + sigma.epsilon^2)
  ll <span style="color: #BFEBBF;">&lt;-</span> compute.ll(x = x, z = z.smooth, sigma = new.sigma, bootstrap = T, B = B, sample.rate = 0.50)
  myTimes <span style="color: #BFEBBF;">&lt;-</span> mle(ll)
  png(file.path(figuresPath,<span style="color: #CC9393;">'/Time_estim/defaultPlots1.png'</span>))
  plot.ll(ll)
  dev.off()
  png(file.path(figuresPath,<span style="color: #CC9393;">'/Time_estim/defaultPlots2.png'</span>))
  plot.mle(ll)
  dev.off()
  png(file.path(figuresPath,<span style="color: #CC9393;">'/Time_estim/ownPlots1.png'</span>))
  plot(density(myTimes),main=<span style="color: #CC9393;">'Estimated times density'</span>)
  dev.off()
  png(file.path(figuresPath,<span style="color: #CC9393;">'/Time_estim/ownPlots2.png'</span>))
  plot(oldTime, as.numeric(myTimes),xlab=<span style="color: #CC9393;">'Old times'</span>,ylab=<span style="color: #CC9393;">'Estimated times'</span>,xlim=c(-5,50),ylim=c(-5,50))
  abline(0,1,col=2,lwd=2)
  abline(v=oldTime,lwd=0.5,lty=3)
  dev.off()
  <span style="color: #F0DFAF; font-weight: bold;">return</span>(myTimes)
}

<span style="color: #93E0E3;">ascendingTime</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(x){
  current <span style="color: #BFEBBF;">&lt;-</span> 0
  ncycle <span style="color: #BFEBBF;">&lt;-</span> 0
  <span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> 1:length(x)){
    val  <span style="color: #BFEBBF;">&lt;-</span> x[i]+(48*ncycle)
    <span style="color: #F0DFAF; font-weight: bold;">if</span> (val &lt; current){
      current <span style="color: #BFEBBF;">&lt;-</span> val
      val <span style="color: #BFEBBF;">&lt;-</span> val+48
      ncycle <span style="color: #BFEBBF;">&lt;-</span> ncycle+1
    }
    current <span style="color: #BFEBBF;">&lt;-</span> val
    x[i] <span style="color: #BFEBBF;">&lt;-</span> val
  }
  <span style="color: #F0DFAF; font-weight: bold;">return</span>(x)
}


estimatedTimes <span style="color: #BFEBBF;">&lt;-</span> getTimeEstimation(xgene,bozdechPath,LemieuxFunctionsPath,file.path(figPath),B=100)
estimatedTimes[estimatedTimes &lt; 0] <span style="color: #BFEBBF;">&lt;-</span> 0
hpi <span style="color: #BFEBBF;">&lt;-</span> estimatedTimes

<span style="color: #F0DFAF; font-weight: bold;">for</span> (type <span style="color: #F0DFAF; font-weight: bold;">in</span> pData(xgene)$type){
  sel <span style="color: #BFEBBF;">&lt;-</span> pData(xgene)$type == type
  typetime <span style="color: #BFEBBF;">&lt;-</span> estimatedTimes[sel]
  time <span style="color: #BFEBBF;">&lt;-</span> ascendingTime(typetime)
  estimatedTimes[sel] <span style="color: #BFEBBF;">&lt;-</span> time
}

write.csv(estimatedTimes, paste0(outdir, <span style="color: #CC9393;">"/Estimated_Times.csv"</span>))
pData(xgene)$time <span style="color: #BFEBBF;">&lt;-</span> estimatedTimes
pData(xgene_red)$time <span style="color: #BFEBBF;">&lt;-</span> estimatedTimes
pData(xgene)$hpi <span style="color: #BFEBBF;">&lt;-</span> hpi
pData(xgene_red)$hpi <span style="color: #BFEBBF;">&lt;-</span> hpi

                                        <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Save ExpressionSet at gene level</span>
save(xgene,file=paste0(outdir, <span style="color: #CC9393;">'/geneLevel.RData'</span>))
save(xgene_red,file=paste0(outdir, <span style="color: #CC9393;">'/geneLevel_redSignal.RData'</span>))

                                        <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Boxplot after summarization</span>
pdf(file.path(figPath,<span style="color: #CC9393;">'boxplot_afterSummarization.pdf'</span>))
boxplot(exprs(xgene),main=<span style="color: #CC9393;">'summarization method: median poslish'</span>)
dev.off()
</pre>
</div>
</div>
</div>

<div id="outline-container-orgada8321" class="outline-3">
<h3 id="orgada8321"><span class="section-number-3">3.10</span> Save results in CSVs</h3>
<div class="outline-text-3" id="text-3-10">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Save results in CSVs ####</span>

write.csv(xgene@phenoData@data, file = paste0(outdir, <span style="color: #CC9393;">"/experiment_data.csv"</span>))
write.csv(cbind(xgene@featureData@data, exprs(xgene)), paste0(outdir, <span style="color: #CC9393;">"/geneLevel_exp.csv"</span>), row.names=F)
write.csv(cbind(xgene_red@featureData@data, exprs(xgene_red)), paste0(outdir, <span style="color: #CC9393;">"/geneLevel_redSignal_exp.csv"</span>), row.names=F)
</pre>
</div>
</div>
</div>
<div id="outline-container-org2babd9b" class="outline-3">
<h3 id="org2babd9b"><span class="section-number-3">3.11</span> Fold Change</h3>
<div class="outline-text-3" id="text-3-11">
</div>
<div id="outline-container-org109689c" class="outline-4">
<h4 id="org109689c"><span class="section-number-4">3.11.1</span> Probe Level</h4>
<div class="outline-text-4" id="text-3-11-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">FC: Probe Level ####</span>

print(<span style="color: #CC9393;">"Calculating Fold-Changes..."</span>)
<span style="color: #93E0E3;">filter</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(x,y) {x==y}
combs <span style="color: #BFEBBF;">&lt;-</span> cross2(sample_names, sample_names, .filter = filter)

fc <span style="color: #BFEBBF;">&lt;-</span> list()
<span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> combs) {
  fc[[paste0(i[[1]], <span style="color: #CC9393;">"_"</span>,  i[[2]])]] <span style="color: #BFEBBF;">&lt;-</span> exprs(xprobe)[,i[[1]]] - exprs(xprobe)[,i[[2]]]
}

probe_fc <span style="color: #BFEBBF;">&lt;-</span> as.data.frame(fc)
probe_fc <span style="color: #BFEBBF;">&lt;-</span> cbind(fData(xprobe), probe_fc)

write.csv(probe_fc, file = paste0(outdir, <span style="color: #CC9393;">"/proveLevel_FC.csv"</span>), row.names = F)
</pre>
</div>
</div>
</div>

<div id="outline-container-org0004c88" class="outline-4">
<h4 id="org0004c88"><span class="section-number-4">3.11.2</span> Gene Level</h4>
<div class="outline-text-4" id="text-3-11-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">FC: Gene Level ####</span>

<span style="color: #93E0E3;">filter</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(x,y) {x==y}
combs <span style="color: #BFEBBF;">&lt;-</span> cross2(sample_names, sample_names, .filter = filter)

fc <span style="color: #BFEBBF;">&lt;-</span> list()
<span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> combs) {
  fc[[paste0(i[[1]], <span style="color: #CC9393;">"_"</span>,  i[[2]])]] <span style="color: #BFEBBF;">&lt;-</span> exprs(xgene)[,i[[1]]] - exprs(xgene)[,i[[2]]]
}

gene_fc <span style="color: #BFEBBF;">&lt;-</span> as.data.frame(fc)
gene_fc <span style="color: #BFEBBF;">&lt;-</span> cbind(fData(xgene), gene_fc)

write.csv(gene_fc, file = paste0(outdir, <span style="color: #CC9393;">"/geneLevel_FC.csv"</span>), row.names = F)

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7bc4f8c" class="outline-3">
<h3 id="org7bc4f8c"><span class="section-number-3">3.12</span> Arees</h3>
<div class="outline-text-3" id="text-3-12">
</div>
<div id="outline-container-orgffd2a1e" class="outline-4">
<h4 id="orgffd2a1e"><span class="section-number-4">3.12.1</span> Functions</h4>
<div class="outline-text-4" id="text-3-12-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Areas: Functions ####</span>

<span style="color: #93E0E3;">imputePoint</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(xs, ys, tp){

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">"xs" and "ys" must be two vectors of equal length</span>
  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">with the corresponding y(expression) and x(timepoint)</span>
  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">values that form the expression plot of interest (one gene).</span>
  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">"tp" must be the timepoint to impute.</span>
  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">If the timepoint to be imputed is already present, leave it as is.</span>
  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Returns NA if missing the previous or next tp</span>

  <span style="color: #F0DFAF; font-weight: bold;">if</span> (tp <span style="color: #BFEBBF;">%in%</span> xs){

    idx <span style="color: #BFEBBF;">&lt;-</span> which(xs == tp)
    imputed <span style="color: #BFEBBF;">&lt;-</span> list(x=xs[idx], y=ys[idx])

  } <span style="color: #F0DFAF; font-weight: bold;">else</span> {

    before <span style="color: #BFEBBF;">&lt;-</span> which(xs == max(xs[xs &lt; tp]))
    after <span style="color: #BFEBBF;">&lt;-</span> which(xs == min(xs[xs &gt; tp]))

    <span style="color: #F0DFAF; font-weight: bold;">if</span> (is.na(ys[before]) | is.na(ys[after])){

      imputed <span style="color: #BFEBBF;">&lt;-</span> list(x=tp, y=<span style="color: #7CB8BB;">NA</span>)

    } <span style="color: #F0DFAF; font-weight: bold;">else</span> {

      x <span style="color: #BFEBBF;">&lt;-</span> c(xs[c(before, after)])
      y <span style="color: #BFEBBF;">&lt;-</span> c(ys[c(before, after)])

      imputed <span style="color: #BFEBBF;">&lt;-</span> approx(x, y, xout=tp)
    }
  }
  <span style="color: #F0DFAF; font-weight: bold;">return</span>(imputed)
}

<span style="color: #93E0E3;">computeArea</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(eset){

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Takes an eset and computes areas.</span>
  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">pData(eset) must contain a field named "time" with the time-points.</span>
  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">pData(eset) must have a field named "type" with the grouping variable.</span>

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Set needed variables</span>
  types <span style="color: #BFEBBF;">&lt;-</span> unique(phenoData(eset)$type)
  type <span style="color: #BFEBBF;">&lt;-</span> phenoData(eset)$type
  times <span style="color: #BFEBBF;">&lt;-</span> phenoData(eset)$time

  maxminTP <span style="color: #BFEBBF;">&lt;-</span> max(sapply(types,<span style="color: #F0DFAF; font-weight: bold;">function</span>(x) min(times[type==x])))
  minmaxTP <span style="color: #BFEBBF;">&lt;-</span> min(sapply(types,<span style="color: #F0DFAF; font-weight: bold;">function</span>(x) max(times[type==x])))
  mybreaks <span style="color: #BFEBBF;">&lt;-</span> seq(maxminTP, minmaxTP, length.out=5)
  tp1 <span style="color: #BFEBBF;">&lt;-</span> mybreaks[2]
  tp2 <span style="color: #BFEBBF;">&lt;-</span> mybreaks[3]
  tp3 <span style="color: #BFEBBF;">&lt;-</span> mybreaks[4]

  xsList <span style="color: #BFEBBF;">&lt;-</span> c()
  <span style="color: #F0DFAF; font-weight: bold;">for</span> (type <span style="color: #F0DFAF; font-weight: bold;">in</span> types){
    xsList <span style="color: #BFEBBF;">&lt;-</span> c(xsList, list(pData(eset)$time[phenoData(eset)$type == type]))
  }

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Main loop</span>
  all_areas <span style="color: #BFEBBF;">&lt;-</span> c()
  <span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> 1:dim(eset)[1]){

    gene <span style="color: #BFEBBF;">&lt;-</span> fData(eset)$geneID[i]

    ysList <span style="color: #BFEBBF;">&lt;-</span> c()
    <span style="color: #F0DFAF; font-weight: bold;">for</span> (type <span style="color: #F0DFAF; font-weight: bold;">in</span> types){
      ysList <span style="color: #BFEBBF;">&lt;-</span> c(ysList, list(exprs(eset)[i, phenoData(eset)$type == type]))
    }

    <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Estimate points where needed</span>
    dfs <span style="color: #BFEBBF;">&lt;-</span> list()
    <span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> 1:length(xsList)){

      x <span style="color: #BFEBBF;">&lt;-</span> unlist(xsList[[i]])
      y <span style="color: #BFEBBF;">&lt;-</span> unlist(ysList[[i]])

      points <span style="color: #BFEBBF;">&lt;-</span> as.data.frame(cbind(x, y))
      midpoints <span style="color: #BFEBBF;">&lt;-</span> points[points$x &gt; maxminTP &amp;
                          points$x &lt; minmaxTP, ]

      first <span style="color: #BFEBBF;">&lt;-</span> imputePoint(x, y, maxminTP)
      last <span style="color: #BFEBBF;">&lt;-</span> imputePoint(x, y, minmaxTP)
      p1 <span style="color: #BFEBBF;">&lt;-</span> imputePoint(x, y, tp1)
      p2 <span style="color: #BFEBBF;">&lt;-</span> imputePoint(x, y, tp2)
      p3 <span style="color: #BFEBBF;">&lt;-</span> imputePoint(x, y, tp3)

      impPoints <span style="color: #BFEBBF;">&lt;-</span> rbind(first, last, p1, p2, p3)
      allpoints <span style="color: #BFEBBF;">&lt;-</span> rbind(midpoints, impPoints)
      allpoints$x <span style="color: #BFEBBF;">&lt;-</span> as.numeric(allpoints$x)
      allpoints$y <span style="color: #BFEBBF;">&lt;-</span> as.numeric(allpoints$y)

      ordered <span style="color: #BFEBBF;">&lt;-</span> arrange(allpoints, allpoints$x)

      dfs[[i]] <span style="color: #BFEBBF;">&lt;-</span> ordered
    }

    <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Calculate minY on estimated DFs</span>
    minY <span style="color: #BFEBBF;">&lt;-</span> min(sapply(dfs, <span style="color: #F0DFAF; font-weight: bold;">function</span>(df) min(df$y, na.rm = T)))

    rowareas <span style="color: #BFEBBF;">&lt;-</span> c()
    <span style="color: #F0DFAF; font-weight: bold;">for</span> (df <span style="color: #F0DFAF; font-weight: bold;">in</span> dfs){

      df$y <span style="color: #BFEBBF;">&lt;-</span> df$y - minY

      <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Whole polygon from expression data</span>
      polDF <span style="color: #BFEBBF;">&lt;-</span> rbind(df,
                     c(minmaxTP, 0),
                     c(maxminTP, 0),
                     c(df[1,]))

      <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Create Polygons</span>
      leftHalf <span style="color: #BFEBBF;">&lt;-</span> rbind(df[which(df$x &lt;= tp2),],
                        c(tp2, 0),
                        c(maxminTP, 0),
                        c(df[1,]))

      rightHalf <span style="color: #BFEBBF;">&lt;-</span> rbind(df[which(df$x &gt;= tp2),],
                         c(minmaxTP, 0),
                         c(tp2, 0),
                         c(df[df$x == tp2,]))

      mid <span style="color: #BFEBBF;">&lt;-</span> rbind(df[which(df$x &gt;= tp1 &amp; df$x &lt;= tp3),],
                   c(tp3, 0),
                   c(tp1, 0),
                   c(df[df$x == tp1,]))

      sides <span style="color: #BFEBBF;">&lt;-</span> rbind(df[which(df$x &lt;= tp1),],
                     c(tp1, 0),
                     c(tp3, 0),
                     df[which(df$x &gt;= tp3),],
                     c(minmaxTP, 0),
                     c(maxminTP, 0),
                     df[1,])

      pols <span style="color: #BFEBBF;">&lt;-</span> list(leftHalf, rightHalf, mid, sides)

      <span style="color: #93E0E3;">calcArea</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(x) {ifelse(any(is.na(x)), <span style="color: #7CB8BB;">NA</span>, Polygon(x)@area)}
      areas <span style="color: #BFEBBF;">&lt;-</span> unlist(lapply(pols, <span style="color: #F0DFAF; font-weight: bold;">function</span>(x) calcArea(x)))

      rowareas <span style="color: #BFEBBF;">&lt;-</span> c(rowareas, areas)

      <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Plot polygons (for debugging purposes)</span>
      <span style="color: #5F7F5F;">##</span><span style="color: #7F9F7F;">pol &lt;- Polygon(polDF)</span>
      <span style="color: #5F7F5F;">##</span><span style="color: #7F9F7F;">ps = Polygons(list(pol),1)</span>
      <span style="color: #5F7F5F;">##</span><span style="color: #7F9F7F;">sps = SpatialPolygons(list(ps))</span>
      <span style="color: #5F7F5F;">##</span><span style="color: #7F9F7F;">plot(sps)</span>
    }
    all_areas <span style="color: #BFEBBF;">&lt;-</span> c(all_areas, list(rowareas))
  }

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Set row and col names for output</span>
  areaDF <span style="color: #BFEBBF;">&lt;-</span> do.call(rbind, all_areas)
  titles <span style="color: #BFEBBF;">&lt;-</span> c(<span style="color: #CC9393;">"Left"</span>, <span style="color: #CC9393;">"Right"</span>, <span style="color: #CC9393;">"Middle"</span>, <span style="color: #CC9393;">"Sides"</span>)

  cols <span style="color: #BFEBBF;">&lt;-</span> c()
  <span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> types){
    <span style="color: #F0DFAF; font-weight: bold;">for</span> (t <span style="color: #F0DFAF; font-weight: bold;">in</span> titles){
      name <span style="color: #BFEBBF;">&lt;-</span> paste0(i, <span style="color: #CC9393;">"_"</span>, t)
      cols <span style="color: #BFEBBF;">&lt;-</span> c(cols, name)
    }
  }
  colnames(areaDF)  <span style="color: #BFEBBF;">&lt;-</span> cols
  rownames(areaDF) <span style="color: #BFEBBF;">&lt;-</span> rownames(exprs(eset))
  <span style="color: #F0DFAF; font-weight: bold;">return</span>(areaDF)
}

</pre>
</div>
</div>
</div>
<div id="outline-container-orga92f08d" class="outline-4">
<h4 id="orga92f08d"><span class="section-number-4">3.12.2</span> Calls: Compute Areas</h4>
<div class="outline-text-4" id="text-3-12-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Calls: Compute Areas ####</span>

print(<span style="color: #CC9393;">"Computing Areas..."</span>)
areasDF <span style="color: #BFEBBF;">&lt;-</span> computeArea(xgene)
xout <span style="color: #BFEBBF;">&lt;-</span> cbind(fData(xgene), areasDF)

write.csv(xout, paste0(outdir, <span style="color: #CC9393;">"/area_geneLevel.csv"</span>), row.names=F)
</pre>
</div>
</div>
</div>
<div id="outline-container-org538b9dc" class="outline-4">
<h4 id="org538b9dc"><span class="section-number-4">3.12.3</span> Calculate aAFC (average Area Fold-Change)</h4>
<div class="outline-text-4" id="text-3-12-3">
</div>
<ol class="org-ol">
<li><a id="orgfacbe6c"></a>Custom Max<br />
<div class="outline-text-5" id="text-3-12-3-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Calculate aAFC (average Area Fold-Change) ####</span>

<span style="color: #93E0E3;">myMax</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(x){
  y <span style="color: #BFEBBF;">&lt;-</span> abs(x)
  <span style="color: #F0DFAF; font-weight: bold;">if</span> (all(is.na(y))){
    <span style="color: #F0DFAF; font-weight: bold;">return</span>(list(<span style="color: #7CB8BB;">NA</span>, <span style="color: #7CB8BB;">NA</span>))
  } <span style="color: #F0DFAF; font-weight: bold;">else</span> {
    pos <span style="color: #BFEBBF;">&lt;-</span> which.max(y)
    times <span style="color: #BFEBBF;">&lt;-</span> c(<span style="color: #CC9393;">"Left"</span>, <span style="color: #CC9393;">"Right"</span>, <span style="color: #CC9393;">"Mid"</span>, <span style="color: #CC9393;">"Sides"</span>)
    <span style="color: #F0DFAF; font-weight: bold;">return</span>(list(maxVal = x[pos],
                maxTime = times[pos]))
  }
}
</pre>
</div>
</div>
</li>
<li><a id="orgda46d96"></a>Calculate Differences and Max<br />
<div class="outline-text-5" id="text-3-12-3-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Get number of categories.</span>
n <span style="color: #BFEBBF;">&lt;-</span> length(levels(pData(xgene)$type))

ns <span style="color: #BFEBBF;">&lt;-</span> list()
i <span style="color: #BFEBBF;">&lt;-</span> 1
<span style="color: #F0DFAF; font-weight: bold;">while</span> (i &lt; n+1){
  ns[[i]] <span style="color: #BFEBBF;">&lt;-</span> 1:4+(4*(i-1))
  i <span style="color: #BFEBBF;">&lt;-</span> i+1
}

<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Convert de areasDF into a list of DFs separated by types.</span>
areas <span style="color: #BFEBBF;">&lt;-</span> list()
<span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> 1:length(ns)) {
  areas[[i]] <span style="color: #BFEBBF;">&lt;-</span> areasDF[,ns[[i]]]
}


<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Calculate area differences</span>

types <span style="color: #BFEBBF;">&lt;-</span> unique(phenoData(xgene)$type)
type <span style="color: #BFEBBF;">&lt;-</span> phenoData(xgene)$type
times <span style="color: #BFEBBF;">&lt;-</span> phenoData(xgene)$time

maxminTP <span style="color: #BFEBBF;">&lt;-</span> max(sapply(types,<span style="color: #F0DFAF; font-weight: bold;">function</span>(x) min(times[type==x])))
minmaxTP <span style="color: #BFEBBF;">&lt;-</span> min(sapply(types,<span style="color: #F0DFAF; font-weight: bold;">function</span>(x) max(times[type==x])))
mybreaks <span style="color: #BFEBBF;">&lt;-</span> seq(maxminTP, minmaxTP, length.out=5)

sets <span style="color: #BFEBBF;">&lt;-</span> 1:length(areas)
combs <span style="color: #BFEBBF;">&lt;-</span> combn(sets, 2)
span <span style="color: #BFEBBF;">&lt;-</span> mybreaks[3] - mybreaks[1]
titles <span style="color: #BFEBBF;">&lt;-</span> c(<span style="color: #CC9393;">"Left"</span>, <span style="color: #CC9393;">"Right"</span>, <span style="color: #CC9393;">"Middle"</span>, <span style="color: #CC9393;">"Sides"</span>)


areaDifs <span style="color: #BFEBBF;">&lt;-</span> list()
<span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> 1:dim(combs)[2]){

  one <span style="color: #BFEBBF;">&lt;-</span> combs[1,i]
  two <span style="color: #BFEBBF;">&lt;-</span> combs[2,i]

  dif1 <span style="color: #BFEBBF;">&lt;-</span> as.data.frame((areas[[one]] - areas[[two]])/span)
  names  <span style="color: #BFEBBF;">&lt;-</span> paste0(colnames(areas[[one]]),
                   <span style="color: #CC9393;">"_minus_"</span>,
                   colnames(areas[[two]]))

  prefix <span style="color: #BFEBBF;">&lt;-</span> paste0(strsplit(colnames(areas[[one]])[1], <span style="color: #CC9393;">"_"</span>)[[1]][1],
                   <span style="color: #CC9393;">"-"</span>,
                   strsplit(colnames(areas[[two]])[1], <span style="color: #CC9393;">"_"</span>)[[1]][1])
  names <span style="color: #BFEBBF;">&lt;-</span> sapply(titles, <span style="color: #F0DFAF; font-weight: bold;">function</span>(x) paste(prefix, x, sep = <span style="color: #CC9393;">"_"</span>))

  colnames(dif1) <span style="color: #BFEBBF;">&lt;-</span> names

  maxval <span style="color: #BFEBBF;">&lt;-</span> apply(dif1, 1, <span style="color: #F0DFAF; font-weight: bold;">function</span>(x) myMax(x)[[1]])
  maxtime <span style="color: #BFEBBF;">&lt;-</span> apply(dif1, 1, <span style="color: #F0DFAF; font-weight: bold;">function</span>(x) myMax(x)[[2]])

  mv <span style="color: #BFEBBF;">&lt;-</span> paste0(prefix, <span style="color: #CC9393;">"_MaxVal"</span>)
  mt <span style="color: #BFEBBF;">&lt;-</span> paste0(prefix, <span style="color: #CC9393;">"_MaxTime"</span>)

  dif1[mv] <span style="color: #BFEBBF;">&lt;-</span> maxval
  dif1[mt] <span style="color: #BFEBBF;">&lt;-</span> maxtime

                                        <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">dif2 &lt;- -dif1</span>

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">prefix &lt;- paste0(strsplit(colnames(areas[[two]])[1], "_")[[1]][1],</span>
  <span style="color: #5F7F5F;">##                  </span><span style="color: #7F9F7F;">"-",</span>
  <span style="color: #5F7F5F;">##                  </span><span style="color: #7F9F7F;">strsplit(colnames(areas[[one]])[1], "_")[[1]][1])</span>
  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">names &lt;- sapply(titles, function(x) paste(prefix, x, sep = "_"))</span>

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">colnames(dif2) &lt;- names</span>

  areaDifs <span style="color: #BFEBBF;">&lt;-</span> c(areaDifs, list(dif1))<span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">, list(dif2))</span>
}

allDifs <span style="color: #BFEBBF;">&lt;-</span> do.call(cbind, areaDifs)
head(allDifs)
</pre>
</div>
</div>
</li>
<li><a id="org58b9950"></a>Convert Partitions into life stages<br />
<div class="outline-text-5" id="text-3-12-3-3">
<p>
We consider the the timepoint in the middle of a partition (left,right,mid,sides) as it's timepoint.
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Areas: Convert Partitions into life stages ####</span>

<span style="color: #93E0E3;">timetostage</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(tp){
  <span style="color: #F0DFAF; font-weight: bold;">while</span>(tp &gt; 48){
    tp = tp-48
  }
  <span style="color: #F0DFAF; font-weight: bold;">return</span>(tp)
}

<span style="color: #93E0E3;">getStage</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(tp) {
  <span style="color: #F0DFAF; font-weight: bold;">if</span> ((tp &gt;= 0) &amp; (tp &lt; 26)) {stg = <span style="color: #CC9393;">"ring"</span>}
  <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> ((tp &gt;= 26) &amp; (tp &lt; 38)) {stg = <span style="color: #CC9393;">"troph"</span>}
  <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> ((tp &gt;= 38) &amp; (tp &lt;= 48)) {stg = <span style="color: #CC9393;">"schizont"</span>}
  <span style="color: #F0DFAF; font-weight: bold;">return</span>(stg)
}

<span style="color: #93E0E3;">fracToStage</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(frac, tps){
  <span style="color: #F0DFAF; font-weight: bold;">if</span> (is.na(frac)){
    <span style="color: #F0DFAF; font-weight: bold;">return</span>(<span style="color: #7CB8BB;">NA</span>)
  } <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (frac == <span style="color: #CC9393;">"Left"</span>){
    tp = tps[2]
    getStage(tp)
  } <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (frac == <span style="color: #CC9393;">"Right"</span>){
    tp = tps[4]
    getStage(tp)
  } <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (frac == <span style="color: #CC9393;">"Mid"</span>){
    tp = tps[3]
    getStage(tp)
  } <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (frac == <span style="color: #CC9393;">"Sides"</span>){
    tp1 = tps[1]+(span/4)
    tp2 = tps[4]+(span/4)
    stg1 <span style="color: #BFEBBF;">&lt;-</span> getStage(tp1)
    stg2 <span style="color: #BFEBBF;">&lt;-</span> getStage(tp2)
    <span style="color: #F0DFAF; font-weight: bold;">return</span>(paste0(stg1,<span style="color: #CC9393;">"-"</span>,stg2))
  }
}


ncombs <span style="color: #BFEBBF;">&lt;-</span> dim(combs)[2]

maxValCols <span style="color: #BFEBBF;">&lt;-</span> seq(5, ncombs*6, 6)
maxTimeCols <span style="color: #BFEBBF;">&lt;-</span> seq(6, ncombs*6, 6)

aMAFC <span style="color: #BFEBBF;">&lt;-</span> cbind(allDifs[,c(maxValCols, maxTimeCols)])

timeCols <span style="color: #BFEBBF;">&lt;-</span> (ncombs+1):(ncombs*2)

tps <span style="color: #BFEBBF;">&lt;-</span> sapply(mybreaks, <span style="color: #F0DFAF; font-weight: bold;">function</span>(x) timetostage(x))

<span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> timeCols){
  aMAFC[,i] <span style="color: #BFEBBF;">&lt;-</span> sapply(aMAFC[,i], <span style="color: #F0DFAF; font-weight: bold;">function</span>(x) fracToStage(x, tps))
}

write.csv(allDifs, paste0(outdir, <span style="color: #CC9393;">"/areaDiferences_geneLevel.csv"</span>))
write.csv(aMAFC, paste0(outdir, <span style="color: #CC9393;">"/aMAFC_geneLevel.csv"</span>))

</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org93c8db0" class="outline-3">
<h3 id="org93c8db0"><span class="section-number-3">3.13</span> Plots</h3>
<div class="outline-text-3" id="text-3-13">
</div>
<div id="outline-container-org080329c" class="outline-4">
<h4 id="org080329c"><span class="section-number-4">3.13.1</span> PCA Plots</h4>
<div class="outline-text-4" id="text-3-13-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">PCA Plots ####</span>

print(<span style="color: #CC9393;">"Plotting PCA.."</span>)
noNA <span style="color: #BFEBBF;">&lt;-</span> xgene[complete.cases(exprs(xgene))]
df <span style="color: #BFEBBF;">&lt;-</span> t(exprs(noNA))
df <span style="color: #BFEBBF;">&lt;-</span> as.data.frame(df)

pca <span style="color: #BFEBBF;">&lt;-</span> prcomp(df)
cmp1 <span style="color: #BFEBBF;">&lt;-</span> format(round(summary(pca)$importance[2,1]*100, 2), nsmall = 2)
cmp2 <span style="color: #BFEBBF;">&lt;-</span> format(round(summary(pca)$importance[2,2]*100, 2), nsmall = 2)

df_pca <span style="color: #BFEBBF;">&lt;-</span> as.data.frame(pca$x)
df_pca$Type <span style="color: #BFEBBF;">&lt;-</span> noNA@phenoData@data$type
df_pca$Time <span style="color: #BFEBBF;">&lt;-</span> noNA@phenoData@data$time

p <span style="color: #BFEBBF;">&lt;-</span> ggplot(df_pca, aes(x=PC1,y=PC2, col = Type, group = Type))
p <span style="color: #BFEBBF;">&lt;-</span> p + geom_point(aes(size= Time))
p <span style="color: #BFEBBF;">&lt;-</span> p + geom_path()
p <span style="color: #BFEBBF;">&lt;-</span> p + scale_x_continuous(name=paste0(<span style="color: #CC9393;">"PC1: "</span>, cmp1, <span style="color: #CC9393;">"%"</span>))
p <span style="color: #BFEBBF;">&lt;-</span> p + scale_y_continuous(name=paste0(<span style="color: #CC9393;">"PC2: "</span>, cmp2, <span style="color: #CC9393;">"%"</span>))

ggsave(p, filename = paste0(figPath, <span style="color: #CC9393;">"PCA.png"</span>), device = <span style="color: #CC9393;">"png"</span>, dpi = <span style="color: #CC9393;">"retina"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc33be61" class="outline-4">
<h4 id="orgc33be61"><span class="section-number-4">3.13.2</span> Expression Plots</h4>
<div class="outline-text-4" id="text-3-13-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">#### </span><span style="color: #7F9F7F;">Expression Plots ####</span>

print(<span style="color: #CC9393;">"Plotting Expression Plots..."</span>)
<span style="color: #93E0E3;">expressionPlot</span> <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #F0DFAF; font-weight: bold;">function</span>(type){

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Set df and lims depending on what we are plotting.</span>
  <span style="color: #F0DFAF; font-weight: bold;">if</span> (type == <span style="color: #CC9393;">"gene"</span>){
    df = xgene
    path = <span style="color: #CC9393;">"/Ratio/Gene_Level/"</span>

  } <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (type == <span style="color: #CC9393;">"gene_red"</span>){
    df = xgene_red
    path = <span style="color: #CC9393;">"/Red_Signal/Gene_Level/"</span>

  } <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (type == <span style="color: #CC9393;">"probe"</span>){
    df = xprobe
    path = <span style="color: #CC9393;">"/Ratio/Probe_Level/"</span>

  } <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (type == <span style="color: #CC9393;">"probe_red"</span>){
    df = xprobe_red
    path = <span style="color: #CC9393;">"/Red_Signal/Probe_Level/"</span>

  }

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Set ylims</span>
  ylim = c(min(exprs(df), na.rm = T), max(exprs(df), na.rm = T))

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Set number of plots</span>
  <span style="color: #F0DFAF; font-weight: bold;">if</span> (run_all_plots == <span style="color: #CC9393;">"yes"</span>){
    nplots = dim(df)[1]
  } <span style="color: #F0DFAF; font-weight: bold;">else</span> {
    nplots = 20
  }

  <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Main Loop</span>
  <span style="color: #F0DFAF; font-weight: bold;">for</span> (i <span style="color: #F0DFAF; font-weight: bold;">in</span> 1:nplots){

    <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Set gene for title or gene and probe for probe-level plots.</span>
    gn <span style="color: #BFEBBF;">&lt;-</span> gsub(<span style="color: #CC9393;">"[/:;.]"</span>, <span style="color: #CC9393;">"_"</span>, fData(df)$Gene_id[i])
    <span style="color: #F0DFAF; font-weight: bold;">if</span> (type <span style="color: #BFEBBF;">%in%</span> c(<span style="color: #CC9393;">"probe"</span>, <span style="color: #CC9393;">"probe_red"</span>)){
      prb <span style="color: #BFEBBF;">&lt;-</span> paste0(<span style="color: #CC9393;">"_"</span>, gsub(<span style="color: #CC9393;">"[/:;.]"</span>, <span style="color: #CC9393;">"_"</span> , fData(xprobe)$ProbeName[i]))
    } <span style="color: #F0DFAF; font-weight: bold;">else</span> {
      prb <span style="color: #BFEBBF;">&lt;-</span> <span style="color: #CC9393;">""</span>
    }
    title <span style="color: #BFEBBF;">&lt;-</span> paste0(gn, prb)

    <span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">Plot</span>
    graf <span style="color: #BFEBBF;">&lt;-</span> melt(df[i,])
    graf[<span style="color: #CC9393;">"Type"</span>] <span style="color: #BFEBBF;">&lt;-</span> xgene@phenoData@data$type
    graf[<span style="color: #CC9393;">"Time"</span>] <span style="color: #BFEBBF;">&lt;-</span> xgene@phenoData@data$time
    p <span style="color: #BFEBBF;">&lt;-</span> ggplot(graf, aes(x = Time, y = value, col = Type, group = Type))
    p <span style="color: #BFEBBF;">&lt;-</span> p + geom_point(aes(color = Type, shape = Type)) + geom_line()
    p <span style="color: #BFEBBF;">&lt;-</span> p + coord_cartesian(ylim = ylim)
    p <span style="color: #BFEBBF;">&lt;-</span> p + ggtitle(title)
    ggsave(p, file=paste0(figPath, path, gn, prb, <span style="color: #CC9393;">".jpeg"</span>),
           device = <span style="color: #CC9393;">"jpeg"</span>, width = 14, height = 10, units = <span style="color: #CC9393;">"cm"</span>)

  }

}

expressionPlot(<span style="color: #CC9393;">"gene"</span>)
expressionPlot(<span style="color: #CC9393;">"gene_red"</span>)
expressionPlot(<span style="color: #CC9393;">"probe"</span>)
expressionPlot(<span style="color: #CC9393;">"probe_red"</span>)
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 15/06/2019</p>
<p class="author">Author: Lucas Michel TodÃ³</p>
<p class="date">Created: 2020-07-10 Fri 11:35</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
